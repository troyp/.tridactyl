#!/bin/bash

# ───────────────────────────────────────────────────────────────────────────────
# ╭────────────╮
# │            │
# │  KWSEARCH  │
# │            │
# ╰────────────╯

# ╭─────────╮
# │ options │
# ╰─────────╯
SHORT="h,f:,k,K:,m,s,S,t,u,y,Y"
LONG="help,filter:,keyword-only,find-keyword:,multi-select,select,select-keyword,tridactyl,url,yank,yank-only"
PARSED=$(getopt -a -n kwsearch --options "$SHORT" --longoptions "$LONG" -- "$@")

eval set -- "$PARSED"

while :
do
    case "$1" in
        -h | --help)
            cat <<EOF
USAGE: kwsearch [OPTION...]
       kwsearch [-k] [-m|-s] [-y] [SEARCHTERM...]
       kwsearch [-K KW] [-y] [SEARCHTERM...]
    Access keyword (and other) bookmarks from bookmarks.json file. The bookmarks
    file can specified with the environment variable BMARKFILE.
    If SEARCHTERMs are specified, resolve search bookmarks by replacing %s with
    the SEARCHTERMs (escaping not yet supported).

Options:
  -f RE  --filter RE          filter bookmarks with RE
  -h,    --help               show help
  -k     --keyword-only       keyword bookmarks only
  -K KW  --find-keyword KW    find bookmark with keyword KW
  -m     --multi-select       choose multiple bookmarks with Rofi
  -s     --select             choose bookmark with Rofi
  -S     --select-keyword     choose bookmark keyword with Rofi
  -t     --tridactyl          format as tridactyl searchurl setting
  -u     --url                print URL only
  -y     --yank               copy output to clipboard
  -Y     --yank-only          send output to clipboard, no output
EOF
            exit 0
            ;;
        (-f | --filter) filter="$2"; shift 2; ;;
        (-k | --keyword-only) kwonly=t; shift; ;;
        (-K | --find-keyword) kw="$2"; shift 2; ;;
        (-m | --multi-select) multi="t"; shift; ;;
        (-s | --select) select="t"; shift; ;;
        (-S | --select-keyword) kwonly=t; select="kw"; shift; ;;
        (-t | --tridactyl) tri="t"; shift; ;;
        (-u | --url) url=t; shift; ;;
        (-y | --yank) yank=t; shift; ;;
        (-Y | --yank-only) yank=only; shift; ;;
        (--) shift; break ;;
        (*)  echo "unrecognized option: $1" >&2 ; exit 1; ;;
    esac
done

# handle additional arguments
if [[ $# -gt 0 ]]; then
    args=t;
    url=t;
fi;

# ╭──────────────╮
# │ dependencies │
# ╰──────────────╯
# is grep -P supported? If not, use grep -E
RETYPE=$(echo | grep -P "" &>/dev/null && printf P || printf E);
# env var for yank command
KWSEARCH_YANKCMD=${KWSEARCH_YANKCMD:-xsel -ib};

# ╭────────────╮
# │ main logic │
# ╰────────────╯
cat "${BMARKFILE:-$HOME/bookmarks/bookmarks.json}" | jq -rc '
            recurse(.children[]?)
            | select(.uri)
            | {kw: .keyword, title: .title, url: .uri}
' | {
    # --keyword-only
    if [[ -n $kwonly ]]; then
        jq -c 'select(.kw)';
    else cat;
    fi;
} | {
    # select by --find-keyword ?
    if [[ -n $kw ]]; then
        jq -c "select(.kw == \"$kw\")";
    else {
        # filter results
            # filter with regex
            if [[ -n filter ]]; then grep -i -$RETYPE "$filter";
            else cat;
            fi;
        } | {
            # select with rofi
            if [[ -n $select ]]; then
                rofithemestr='#window {width: 80%;} #listview {lines: 25;}';
                if [[ $select == kw ]]; then

                    rofi -theme-str "$rofithemestr" -dmenu -i -no-custom -filter '"kw":"';
                else
                    rofi -theme-str "$rofithemestr" -dmenu -i -no-custom;
                fi;
            elif [[ -n $multi ]]; then
                rofi -dmenu -i -no-custom -multi-select;
            else cat
            fi;
        }
    fi;
} | {
    # output format
    if [[ -n $url ]]; then
        # URL only
        jq -r '.url';
    elif [[ -n $tri ]]; then
        # tridactyl searchurl
        \perl -pe 's/{"kw":"(.*)","title":"(.*)","url":"(.*)"}/set searchurls.$1 $3/';
    else
        # JSON
        cat;
    fi;
} | {
    # arguments: resolve search bookmark URLs
    if [[ -n $args ]]; then
        # TODO: handle | in arguments
        # TODO: handle escaping in search URL
        sed "s|%s|$*|";
    else
        cat;
    fi;
} | {
    if [[ -n $yank ]]; then
        # put results in clipboard
        if [[ $yank == only ]]; then
            eval $KWSEARCH_YANKCMD;
        else
            tee >(eval $KWSEARCH_YANKCMD);
        fi;
    else
        cat;
    fi;
}
